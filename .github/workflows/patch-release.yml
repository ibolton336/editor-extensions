name: Patch Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Release branch (e.g., release-0.4)"
        required: true
        type: string
      dry_run:
        description: "Preview actions without making changes"
        required: false
        type: boolean
        default: false

env:
  HUSKY: 0

jobs:
  compute-version:
    name: Compute Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc.outputs.version }}
      tag: ${{ steps.calc.outputs.tag }}
      has_changes: ${{ steps.calc.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Compute base version
        id: base
        run: |
          BASE=$(echo "${{ inputs.branch }}" | sed 's/release-//')
          echo "base_version=$BASE" >> "$GITHUB_OUTPUT"

      - name: Compute next version
        id: calc
        uses: ./.github/actions/compute-version
        with:
          base_version: ${{ steps.base.outputs.base_version }}

      - name: Skip summary
        if: steps.calc.outputs.has_changes != 'true'
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Patch Release Skipped
          No new commits on \`${{ inputs.branch }}\` since \`${{ steps.calc.outputs.prev_tag }}\`.
          EOF

      - name: Dry run summary
        if: inputs.dry_run && steps.calc.outputs.has_changes == 'true'
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## [DRY RUN] Patch Release

          **Tag:** \`${{ steps.calc.outputs.tag }}\`
          **Branch:** \`${{ inputs.branch }}\`

          No changes made.
          EOF

  release:
    name: Release
    needs: compute-version
    if: >-
      needs.compute-version.outputs.has_changes == 'true'
      && !inputs.dry_run
    uses: ./.github/workflows/release.yml
    with:
      version: ${{ needs.compute-version.outputs.version }}
      tag: ${{ needs.compute-version.outputs.tag }}
      prerelease: false
      ref: ${{ inputs.branch }}
    secrets: inherit

  housekeeping:
    name: Assemble Changelog
    runs-on: ubuntu-latest
    needs: [compute-version, release]
    if: ${{ !inputs.dry_run && needs.compute-version.outputs.has_changes == 'true' }}
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Get Token
        id: get_workflow_token
        uses: peter-murray/workflow-application-token-action@v3
        with:
          application_id: ${{ vars.KONVEYOR_BOT_ID }}
          application_private_key: ${{ secrets.KONVEYOR_BOT_KEY }}

      - name: Configure git
        run: |
          git config user.name "konveyor-bot"
          git config user.email "konveyor-bot@users.noreply.github.com"
          git remote set-url origin \
            "https://x-access-token:${{ steps.get_workflow_token.outputs.token }}@github.com/${{ github.repository }}.git"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Install dependencies
        run: npm ci

      - name: Assemble changelog
        run: |
          npm run changelog:assemble -- "${{ needs.compute-version.outputs.tag }}"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "assemble changelog for ${{ needs.compute-version.outputs.tag }}"
            git push origin ${{ inputs.branch }}
          else
            echo "No changelog fragments to assemble"
          fi

      - name: Summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Post-Release Housekeeping

          | Step | Result |
          |------|--------|
          | Changelog | assembled on \`${{ inputs.branch }}\` |
          | Tag | \`${{ needs.compute-version.outputs.tag }}\` |
          EOF
