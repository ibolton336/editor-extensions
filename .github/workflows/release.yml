name: Release

on:
  workflow_call:
    inputs:
      version:
        description: "Version to release (e.g., 0.4.0)"
        required: true
        type: string
      tag:
        description: "Tag name (e.g., v0.4.0)"
        required: true
        type: string
      prerelease:
        description: "Is this a pre-release?"
        required: true
        type: boolean
      ref:
        description: "Git ref to build from (e.g., main, release-0.4)"
        required: true
        type: string

env:
  HUSKY: 0

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: xvfb-run -a npm test

  package:
    name: Package
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies and build
        run: |
          npm ci
          npm run build

      - name: Collect runtime assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            npm run collect-assets -- --use-workflow-artifacts --branch=main
          else
            npm run collect-assets -- --use-release
          fi

      - name: Set version
        run: |
          npm version "${{ inputs.version }}" \
            --workspaces --include-workspace-root \
            --no-git-tag-version --allow-same-version

      - name: Assemble changelog (ephemeral, for VSIX content)
        run: npm run changelog:assemble -- "${{ inputs.tag }}"

      - name: Build dist
        run: npm run dist

      - name: Package extensions
        run: |
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            npm run package -- --pre-release
          else
            npm run package
          fi

      - name: Upload VSIX artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vsix-artifacts
          path: ./dist/*.vsix

  e2e:
    name: E2E Tests
    needs: package
    uses: ./.github/workflows/e2e-tests.yml
    with:
      vsix_artifact_name: "vsix-artifacts"
      trigger_context: "release"
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  publish:
    name: Publish to Marketplaces
    runs-on: ubuntu-latest
    needs: e2e
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: vsix-artifacts
          path: ./artifacts

      - name: Verify artifacts
        run: ls -R ./artifacts/

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCODE_MARKETPLACE_TOKEN }}
        run: |
          for vsix in ./artifacts/*.vsix; do
            if [ "${{ inputs.prerelease }}" = "true" ]; then
              echo "Publishing $(basename "$vsix") as pre-release"
              npx @vscode/vsce publish --pre-release --packagePath "$vsix"
            else
              echo "Publishing $(basename "$vsix") as stable release"
              npx @vscode/vsce publish --packagePath "$vsix"
            fi
          done

      - name: Publish to Open VSX
        run: |
          for vsix in ./artifacts/*.vsix; do
            if [ "${{ inputs.prerelease }}" = "true" ]; then
              echo "Publishing $(basename "$vsix") to Open VSX as pre-release"
              npx ovsx publish --pre-release --packagePath "$vsix" \
                --pat ${{ secrets.OVSX_MARKETPLACE_TOKEN }}
            else
              echo "Publishing $(basename "$vsix") to Open VSX as stable release"
              npx ovsx publish --packagePath "$vsix" \
                --pat ${{ secrets.OVSX_MARKETPLACE_TOKEN }}
            fi
          done

  github-release:
    name: Create Tag & GitHub Release
    runs-on: ubuntu-latest
    needs: [package, publish]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Compute previous release tag
        id: prev
        run: |
          PREV=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || true)
          echo "tag=${PREV:-}" >> "$GITHUB_OUTPUT"
          echo "Previous tag: ${PREV:-none}"

      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: vsix-artifacts
          path: ./artifacts

      - name: Generate release notes
        id: notes
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const prev = '${{ steps.prev.outputs.tag }}';
            const current = '${{ inputs.tag }}';
            try {
              const { data } = await github.rest.repos.generateReleaseNotes({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: current,
                previous_tag_name: prev || undefined,
                target_commitish: '${{ inputs.ref }}'
              });
              return data.body;
            } catch (e) {
              console.log('Could not auto-generate notes:', e.message);
              return `Release ${current}`;
            }

      - name: Get Token
        id: get_workflow_token
        uses: peter-murray/workflow-application-token-action@v3
        with:
          application_id: ${{ vars.KONVEYOR_BOT_ID }}
          application_private_key: ${{ secrets.KONVEYOR_BOT_KEY }}

      - name: Resolve target commit
        id: resolve
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Create tag and release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ inputs.tag }}
          commit: ${{ steps.resolve.outputs.sha }}
          body: ${{ steps.notes.outputs.result }}
          artifacts: "./artifacts/*.vsix"
          prerelease: ${{ inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ steps.get_workflow_token.outputs.token }}

      - name: Add release info to summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Release Published

          **Tag:** \`${{ inputs.tag }}\`
          **Version:** \`${{ inputs.version }}\`
          **Pre-release:** ${{ inputs.prerelease }}
          **Ref:** \`${{ inputs.ref }}\`
          EOF
